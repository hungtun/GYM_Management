{% extends "layout/base.html" %}

{% block title %}Dashboard Lễ tân - GYM Beta{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Dashboard Lễ tân</h2>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" id="receptionistTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="member-list-tab" data-bs-toggle="tab"
                    data-bs-target="#member-list" type="button" role="tab" aria-controls="member-list" aria-selected="true">
                Danh sách hội viên
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="register-new-tab" data-bs-toggle="tab"
                    data-bs-target="#register-new" type="button" role="tab" aria-controls="register-new" aria-selected="false">
                Đăng ký hội viên mới
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="receptionistTabsContent">
        <!-- Tab 1: Danh sách hội viên -->
        <div class="tab-pane fade show active" id="member-list" role="tabpanel" aria-labelledby="member-list-tab">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Danh sách hội viên</h5>

                    <!-- Search -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchMember"
                               placeholder="Tìm kiếm theo tên, email, SĐT...">
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>SĐT</th>
                                    <th>Gói tập</th>
                                    <th>Ngày đăng ký</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if members %}
                                    {% for member in members %}
                                    <tr>
                                        <td>{{ member.user.first_name }} {{ member.user.last_name }}</td>
                                        <td>{{ member.user.email }}</td>
                                        <td>{{ member.user.phone or 'N/A' }}</td>
                                        <td>
                                            {% if member.memberships %}
                                                {% for m in member.memberships %}
                                                    {% if m.active %}
                                                        <span class="badge bg-success">{{ m.package.name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="badge bg-danger">Chưa có gói</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ member.register_date.strftime('%d/%m/%Y') if member.register_date else 'N/A' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-detail-btn"
                                                    data-member-id="{{ member.id }}">
                                                Xem chi tiết
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Chưa có hội viên nào</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Đăng ký hội viên mới -->
        <div class="tab-pane fade" id="register-new" role="tabpanel" aria-labelledby="register-new-tab">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Đăng ký hội viên mới</h5>

                    <form method="POST" action="{{ url_for('receptionist_bp.register_member') }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Họ</label>
                                <input type="text" name="first_name" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tên</label>
                                <input type="text" name="last_name" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tên đăng nhập <span class="text-danger">*</span></label>
                                <input type="text" name="user_name" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                                <input type="password" name="password" class="form-control" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" name="phone_number" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày sinh</label>
                                <input type="date" name="birth_day" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Giới tính</label>
                                <select name="gender" class="form-control">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gói tập <span class="text-danger">*</span></label>
                                <select name="package_id" class="form-control" required>
                                    <option value="">Chọn gói tập</option>
                                    {% for package in packages %}
                                    {% if package.package_type == 'GYM' %}
                                    <option value="{{ package.id }}" data-price="{{ package.price }}">
                                        {{ package.name }} - {{ package.duration_months }} tháng -
                                        {{ "{:,.0f}".format(package.price) }} VNĐ
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày đăng ký</label>
                                <input type="date" name="register_date" class="form-control"
                                       value="{{ today }}">
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                Đăng ký và gửi email xác nhận
                            </button>
                            <button type="reset" class="btn btn-secondary ms-2">Đặt lại</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Chi tiết hội viên -->
    <div class="modal fade" id="memberDetailModal" tabindex="-1" aria-labelledby="memberDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberDetailModalLabel">Chi tiết hội viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="memberDetailContent">
                    <div id="memberInfo"></div>
                    <hr>
                    <h6>Thẻ hội viên</h6>
                    <div id="currentMembership"></div>

                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="showPackageSelection()">
                            Đăng ký gói mới / Gia hạn
                        </button>
                    </div>

                    <div id="packageSelection" style="display:none;" class="mt-3">
                        <h6>Chọn gói tập</h6>
                        <form method="POST" id="addPackageForm">
                            <input type="hidden" name="member_id" id="modalMemberId">
                            <select name="package_id" class="form-control mb-2" id="packageSelectDropdown" required>
                                <option value="">Chọn gói tập</option>
                                {% for package in packages %}
                                <option value="{{ package.id }}" data-package-type="{{ package.package_type }}">
                                    {{ package.name }} - {{ package.duration_months }} tháng -
                                    {{ "{:,.0f}".format(package.price) }} VNĐ
                                </option>
                                {% endfor %}
                            </select>
                            <div id="ptWarning" class="alert alert-warning mt-2" style="display:none;">
                                <small><strong>Lưu ý:</strong> Hội viên cần có gói GYM đang hoạt động để đăng ký gói PT!</small>
                            </div>
                            <button type="submit" class="btn btn-success">Xác nhận</button>
                            <button type="button" class="btn btn-secondary" onclick="hidePackageSelection()">Hủy</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewMemberDetail(memberId) {
    fetch(`/receptionist/member/${memberId}/detail`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('memberInfo').innerHTML = data.info_html;
            document.getElementById('currentMembership').innerHTML = data.membership_html;
            document.getElementById('modalMemberId').value = memberId;
            document.getElementById('addPackageForm').action = `/receptionist/member/${memberId}/add-package`;

            // Reset package selection form
            document.getElementById('packageSelection').style.display = 'none';
            document.getElementById('addPackageForm').reset();

            // Filter PT packages if member doesn't have valid GYM package
            const hasValidGym = data.has_valid_gym;
            const dropdown = document.getElementById('packageSelectDropdown');
            const warning = document.getElementById('ptWarning');

            // Reset all options first
            Array.from(dropdown.options).forEach(option => {
                if (option.value) {  // Skip the default "Chọn gói tập" option
                    option.disabled = false;
                    option.style.display = '';
                }
            });

            // If no valid GYM, disable/hide PT packages
            if (!hasValidGym) {
                warning.style.display = 'block';
                Array.from(dropdown.options).forEach(option => {
                    if (option.dataset.packageType === 'PT') {
                        option.disabled = true;
                        option.style.display = 'none';
                    }
                });
            } else {
                warning.style.display = 'none';
            }

            const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
            modal.show();
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Có lỗi xảy ra khi tải thông tin hội viên');
        });
}

function showPackageSelection() {
    document.getElementById('packageSelection').style.display = 'block';
}

function hidePackageSelection() {
    document.getElementById('packageSelection').style.display = 'none';
    document.getElementById('addPackageForm').reset();
}

// Search functionality
document.getElementById('searchMember')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#member-list tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Event listener cho các nút xem chi tiết
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default for register_date
    const registerDateInput = document.querySelector('input[name="register_date"]');
    if (registerDateInput && !registerDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        registerDateInput.value = today;
    }

    // Event listener cho các nút xem chi tiết
    document.querySelectorAll('.view-detail-btn').forEach(button => {
        button.addEventListener('click', function() {
            const memberId = this.getAttribute('data-member-id');
            viewMemberDetail(memberId);
        });
    });
});
</script>
{% endblock %}

